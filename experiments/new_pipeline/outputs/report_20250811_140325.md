# Experimental Pipeline Report

## Overview
- Data: latest `model_lag1_*.csv` (cleaned lag logic)
- Split: time-based, default 2022-08-31
- Macro canonicalization: drop z-variants where base exists; drop duplicate `_lag1.1`
- Feature engineering: per-bank rolling mean/std for windows 3 and 6 months
- Stability selection: 5 time slices; keep features appearing in ≥60% of slices
- Models: CatBoost (class-weighted) by default; fallback Logistic (balanced)

## Runs and Metrics
### Top-2
- Results file: `/home/fj/UkrainianInsolvencyPredictor/experiments/new_pipeline/outputs/results_20250810_224111.json`
- Data: `/home/fj/UkrainianInsolvencyPredictor/data/processed/model_ready/model_lag1_20250810_220848.csv`
- Split: 2022-08-31
- Model: CatBoost (weighted Logloss)
- Selected features: 2
  - Preview: 27_Cross-border deposits with BIS rep. banks, Liquid_Assets_Ratio_std3
- Top stability counts: 27_Cross-border deposits with BIS rep. banks(3), Liquid_Assets_Ratio_std3(3), ukraine_3y_yield_lag1(2), NPL_Ratio_ma3(2), Loan_Deposit_Ratio_std3(2), 24_International reserves (excluding gold)_std3(2), 22_Liabilities to BIS banks, locational, total_std3(2), 27_Cross-border deposits with BIS rep. banks_std3(2), Capital_Ratio(1), NPL_Ratio(1)

```
Train: ROC=0.582 PR=0.138 Brier=0.2461 (n=2948)
Test:  ROC=0.420 PR=0.400 Brier=0.2804 (n=2144)
```

### Top-3
- Results file: `/home/fj/UkrainianInsolvencyPredictor/experiments/new_pipeline/outputs/results_20250810_224250.json`
- Data: `/home/fj/UkrainianInsolvencyPredictor/data/processed/model_ready/model_lag1_20250810_220848.csv`
- Split: 2022-08-31
- Model: CatBoost (weighted Logloss)
- Selected features: 3
  - Preview: 27_Cross-border deposits with BIS rep. banks, Liquid_Assets_Ratio_std3, ukraine_3y_yield_lag1
- Top stability counts: 27_Cross-border deposits with BIS rep. banks(3), ukraine_3y_yield_lag1(3), Liquid_Assets_Ratio_std3(3), NPL_Ratio_ma3(2), Loan_Deposit_Ratio_std3(2), 24_International reserves (excluding gold)_std3(2), 22_Liabilities to BIS banks, locational, total_std3(2), 27_Cross-border deposits with BIS rep. banks_std3(2), 22_Liabilities to BIS banks, locational, total_lag1_ma3(2), Capital_Ratio(1)

```
Train: ROC=0.638 PR=0.153 Brier=0.2381 (n=2948)
Test:  ROC=0.784 PR=0.647 Brier=0.1878 (n=2144)
```

### Top-165
- Results file: `/home/fj/UkrainianInsolvencyPredictor/experiments/new_pipeline/outputs/results_20250810_224504.json`
- Data: `/home/fj/UkrainianInsolvencyPredictor/data/processed/model_ready/model_lag1_20250810_220848.csv`
- Split: 2022-08-31
- Model: CatBoost (weighted Logloss)
- Selected features: 165
  - Preview: WAR, Capital_Ratio, NPL_Ratio, Cost_Income_Ratio, ROA, ROE, Liquid_Assets_Ratio, Loan_Deposit_Ratio, Net_Open_FX_Ratio, 24_International reserves (excluding gold), 12_Liabilities to BIS banks (cons.), short term, 22_Liabilities to BIS banks, locational, total, 01_Cross-border loans from BIS reporting banks, 27_Cross-border deposits with BIS rep. banks, us_3y_yield ...
- Top stability counts: WAR(0), Capital_Ratio(0), NPL_Ratio(0), Cost_Income_Ratio(0), ROA(0), ROE(0), Liquid_Assets_Ratio(0), Loan_Deposit_Ratio(0), Net_Open_FX_Ratio(0), 24_International reserves (excluding gold)(0)

```
Train: ROC=0.961 PR=0.593 Brier=0.0788 (n=2948)
Test:  ROC=0.180 PR=0.305 Brier=0.6447 (n=2144)
```

### All (engineered)
- Results file: `/home/fj/UkrainianInsolvencyPredictor/experiments/new_pipeline/outputs/results_20250810_223258.json`
- Data: `/home/fj/UkrainianInsolvencyPredictor/data/processed/model_ready/model_lag1_20250810_220848.csv`
- Split: 2022-08-31
- Model: CatBoost (weighted Logloss)
- Selected features: 0

```
Train: ROC=0.638 PR=0.153 Brier=0.2381 (n=2948)
Test:  ROC=0.784 PR=0.647 Brier=0.1878 (n=2144)
```

## Pipeline Sequence (Detailed)
1. Load latest `model_lag1_*.csv`
2. Canonicalize macro columns:
   - If both base and z-variant exist, drop z-variant (restandardize later if needed)
   - Drop duplicate naming artifacts: *_lag1.1
3. Assemble base features (exclude ids/presence columns)
4. Add rolling features per bank:
   - For each feature f and window w in {3, 6}: f_ma{w} = rolling mean, f_std{w} = rolling std
5. Split by `split_date` for train/test
6. Stability selection on train:
   - Partition train months into 5 time slices; per slice fit L1-logistic with median imputation + scaling
   - Count features with nonzero coefficients per slice; select those appearing in ≥60%
   - Optionally keep top-K by frequency
7. Train model:
   - CatBoost (weighted Logloss) if available; else logistic (balanced) with median imputation + scaling
8. Score metrics on probabilities (ROC, PR, Brier)
